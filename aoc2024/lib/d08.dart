import 'package:aoc/halp.dart' as h;

int run() {
  var rows = h.rows(inp);
  var size = rows.length;

  List<(int x, int y, String a)> ante = []; // todo Map?
  Set<(int x, int y)> anti = {};

  for (var y = 0; y < size; y++) {
    for (var x = 0; x < size; x++) {
      if (rows[y][x] != '.') {
        ante.add((x, y, rows[y][x]));
      }
    }
  }

  var frequencies = h.groupBy(ante, (a) => a.$3);

  frequencies.forEach((_, value) {
    var foo = value.expand((l) => value.where((a) => l != a).map((r) {
      if (l.$1 < r.$1) {
        return (l, r);
      }
      else if (l.$2 < r.$2 && l.$1 == r.$1) {
        return (l, r);
      }
      else {
        return (r, l);
      }
    })).toSet();

    (int x, int y)? add(int x, int y) {
      if (x < 0 || x > size -1) return null;
      if (y < 0 || y > size -1) return null;

      var value = (x, y);
      anti.add(value);
      return value;
    }

    for (var (aa, bb) in foo) {
      (int, int)? a = (aa.$1, aa.$2);
      (int, int)? b = (bb.$1, bb.$2);

      var downLeftToUpRight = a.$2 > b.$2;

      var dx = h.abs(a.$1 - b.$1);
      var dy = h.abs(a.$2 - b.$2);

      var once = value.length < 3;

      if (!once) {
        add(a.$1, a.$2);
        add(b.$1, b.$2);
      }

      var stop = false;
      while (!stop) {
        if (downLeftToUpRight) {
          if (a != null) a = add(a.$1 - dx, a.$2 + dy);
          if (b != null) b = add(b.$1 + dx, b.$2 - dy);
        } else {
          if (a != null) a = add(a.$1 - dx, a.$2 - dy);
          if (b != null) b = add(b.$1 + dx, b.$2 + dy);
        }

        stop = once || (a == null && b == null);
      }
    }
  });

  for (var y = 0; y < size; y++) {
    StringBuffer r = StringBuffer();
    for (var x = 0; x < size; x++) {
      if (anti.contains((x, y))) {
        r.write('#');
      } else {
        r.write('.');
      }
    }

    print(r.toString());
  }

  //print(anti);

  var sum = anti.length;

  return sum;
}

var ti2 = '''
..........
..........
..........
....a.....
........a.
.....a....
..........
..........
..........
..........
''';

var ti = '''
............
........0...
.....0......
.......0....
....0.......
......A.....
............
............
........A...
.........A..
............
............
''';

var inp = '''
.............4....O..........w....R...............
.................................f................
..............4...j......NW0......................
....................R..W..........................
...............R..................................
..................................................
v.......................f.......0W................
.....9L............l...N.........w................
....L....9.......ON........8......................
.1.........49L........f..0..N.....................
..........................V...l...................
..........4.......................................
.....................j...................3.....U..
....O.....U.......................................
........J......................l..................
.O....s.Q.......j.....l.....w..........F...q......
..................................................
.U.......................j..8.....................
................U...............................3.
2.............................J............3......
..............................F...................
.....s...R...........J..................F.........
.s......................x..........F.....q........
.......2.....Q........3........x..................
...........v......................u...............
..............v...........n......8............q...
.......f..................8........i..............
.5..................1n..............P.....i.......
............7............Q..................X.....
......5...p....................V..................
.................J..........nx............q.......
.......p............W...........................0.
......2.............p.5.....1....P................
......I.................7.X....i...P..............
............s.....r...w................V..........
...............or...6.................V...........
............................PS.7..................
..........o...........................S...........
...........5..............o..1.......n............
...........I.........r.......7.......6............
.................o.r...........X..................
................................x.........u.......
.........p..Q....2................................
.........v.................S.....................u
I...........................S.....6...............
..................................................
.......I..........................................
..................................................
.......................................6..........
.................................X................
''';
